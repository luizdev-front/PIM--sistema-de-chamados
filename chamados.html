<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chamados Abertos - InfoTech</title> 
    <link rel="stylesheet" href="style.css">
</head>
<body>

<header class="header">
    <div class="header-content">
        <div class="logo-container">
            <h1 class="logo">InfoTech <span style="font-size: 0.8rem; font-weight: normal;">| Chamados</span></h1>
        </div>
        <div>
            <button onclick="resetarSistema()" style="background:red; color:white; border:none; padding:5px; border-radius:4px; cursor:pointer; font-size:0.7rem; margin-right:10px;">Resetar Dados</button>
            <button id="btnSair" class="btn-sair">Sair</button>
        </div>
    </div>
</header>

<nav class="tabs">
    <a href="chamados.html" class="active">Abertos</a>
    <a href="andamento.html">Em andamento</a>
    <a href="concluido.html">Concluídos</a>
    <a href="novo_chamado.html" style="background-color: rgba(255,255,255,0.1);">+ Novo Chamado</a>
</nav>

<main>
    <h2>Chamados Abertos</h2>
    <div id="lista-chamados">
        </div>
</main>

<script>
    // --- FUNÇÃO DE EMERGÊNCIA ---
    function resetarSistema() {
        if(confirm("Isso vai apagar todos os chamados e reiniciar o sistema. Tem certeza?")) {
            localStorage.removeItem('bdChamados');
            location.reload(); // Recarrega a página
        }
    }

    // --- LÓGICA PRINCIPAL ---
    try {
        const container = document.getElementById('lista-chamados');
        
        // 1. Tenta carregar os dados
        let dadosBrutos = localStorage.getItem('bdChamados');
        let todosChamados = [];

        // 2. Verifica se existem dados e se são válidos
        if (!dadosBrutos) {
            // Se não tem nada, cria os dados iniciais
            iniciarDadosPadrao();
        } else {
            try {
                todosChamados = JSON.parse(dadosBrutos);
                
                // Verificação extra: Se não for uma lista (array), reseta
                if (!Array.isArray(todosChamados)) {
                    throw new Error("Dados corrompidos");
                }
            } catch (e) {
                console.error("Erro ao ler dados, resetando...", e);
                iniciarDadosPadrao();
            }
        }

        // Função auxiliar para recarregar a variável após reset
        function iniciarDadosPadrao() {
            const padrao = [
                {id: 1, titulo: "Erro no sistema ao salvar", descricao: "Estou enfrentando um erro ao salvar alterações.", status: "aberto", tempo: "há 2 dias", prioridade: "alta"},
                {id: 2, titulo: "Problema de conexão de rede", descricao: "Não consigo acessar a internet.", status: "aberto", tempo: "há 5 dias", prioridade: "media"},
                {id: 3, titulo: "Impressora travada", descricao: "A impressora não responde.", status: "andamento", tempo: "há 1 hora", prioridade: "baixa"}
            ];
            localStorage.setItem('bdChamados', JSON.stringify(padrao));
            todosChamados = padrao;
        }

        // 3. Filtra e Exibe (Apenas Status 'aberto')
        const chamadosAbertos = todosChamados.filter(c => c.status === 'aberto');

        container.innerHTML = ""; // Limpa antes de preencher

        if (chamadosAbertos.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#777; margin-top:20px;">Nenhum chamado aberto.</p>';
        } else {
            chamadosAbertos.forEach(chamado => {
                const div = document.createElement('div');
                div.className = 'chamado-card status-aberto';
                
                // Define cor da prioridade
                let corPrioridade = 'gray';
                if(chamado.prioridade === 'alta') corPrioridade = 'red';
                if(chamado.prioridade === 'media') corPrioridade = 'orange';

                div.innerHTML = `
                    <h3>${chamado.titulo}</h3>
                    <p>${chamado.descricao}</p>
                    <div class="meta-info">
                        <span class="time">Prioridade: <b style="color:${corPrioridade}">${chamado.prioridade ? chamado.prioridade.toUpperCase() : 'NORMAL'}</b></span>
                        <span class="status">#${chamado.id}</span>
                    </div>
                    <button onclick="moverParaAndamento(${chamado.id})" style="margin-top:10px; padding:5px 10px; cursor:pointer; background:#2196F3; color:white; border:none; border-radius:4px;">Atender Chamado</button>
                `;
                container.appendChild(div);
            });
        }

    } catch (erroFatal) {
        alert("Ocorreu um erro no sistema: " + erroFatal.message);
    }

    // --- FUNÇÃO PARA MOVER CHAMADO ---
    function moverParaAndamento(id) {
        let chamados = JSON.parse(localStorage.getItem('bdChamados'));
        // Encontra o chamado e muda o status
        const index = chamados.findIndex(c => c.id === id);
        if (index !== -1) {
            chamados[index].status = 'andamento';
            localStorage.setItem('bdChamados', JSON.stringify(chamados));
            location.reload(); // Recarrega para atualizar a tela
        }
    }

    // Botão Sair
    document.getElementById('btnSair').addEventListener('click', () => {
        window.location.href = 'index.html';
    });

</script>

</body>
</html>
